"""\nAI Chat Service for Trading Bot\nSupports: GPT-5, Claude, Ollama, and Gemini\n"""\nimport os\nimport logging\nfrom dotenv import load_dotenv\n\nload_dotenv()\nlogger = logging.getLogger(__name__)\n\n_chat_instance = None\n\ndef get_trading_context(settings, latest_market_data, open_trades):\n    """Generate context about current trading state"""\n    auto_trading = settings.get('auto_trading', False) if settings else False\n    use_ai = settings.get('use_ai_analysis', False) if settings else False\n    swing_enabled = settings.get('swing_trading_enabled', True) if settings else True\n    day_enabled = settings.get('day_trading_enabled', False) if settings else False\n\n    context = f"""Du bist ein intelligenter Trading-Assistent für Booner-Trade mit DUAL STRATEGY.\n\nAKTUELLE EINSTELLUNGEN:\n- Auto-Trading: {'✅ AKTIV' if auto_trading else '❌ INAKTIV'}\n- AI-Analyse: {'✅ AKTIV' if use_ai else '❌ INAKTIV'}\n- Swing Trading: {'✅ AKTIV' if swing_enabled else '❌ INAKTIV'}\n- Day Trading: {'✅ AKTIV' if day_enabled else '❌ INAKTIV'}\n\nMARKTDATEN (Live):\n"""\n\n    if latest_market_data:\n        for commodity_id, data in latest_market_data.items():\n            if isinstance(data, dict) and 'price' in data:\n                price = data.get('price', 0)\n                signal = data.get('signal', 'HOLD')\n                context += f"\n{commodity_id}: ${price:.2f}, Signal: {signal}"\n\n    context += f"\n\nOFFENE TRADES: {len(open_trades)}"\n    if open_trades:\n        for trade in open_trades[:5]:\n            commodity = trade.get('commodity', 'UNKNOWN')\n            trade_type = trade.get('type', 'UNKNOWN')\n            entry = trade.get('entry_price', 0)\n            profit = trade.get('pnl', 0)\n            context += f"\n- {commodity} {trade_type} @ ${entry:.2f}, P/L: ${profit:.2f}"\n\n    context += """\n\nANTWORTE KURZ UND PRÄZISE auf Deutsch."""\n    return context\n\nasync def get_ai_response(message: str, session_id: str, provider: str, model: str, db):\n    """Get AI response using Emergent Integrations"""\n    try:\n        from emergentintegrations.llm.chat import LlmChat, UserMessage\n        \n        # Get API key\n        api_key = os.getenv('EMERGENT_LLM_KEY')\n        if not api_key:\n            return "Fehler: EMERGENT_LLM_KEY nicht gefunden."\n        \n        # Get context\n        settings = await db.trading_settings.find_one({'id': 'trading_settings'})\n        trades = await db.trades.find({'status': 'OPEN'}).to_list(length=50)\n        market_data = {}\n        \n        context = get_trading_context(settings, market_data, trades)\n        full_message = f"{context}\n\nFRAGE: {message}"\n        \n        # Create chat\n        chat = LlmChat(\n            api_key=api_key,\n            session_id=session_id,\n            system_message="Du bist ein Trading-Assistent für Booner-Trade. Antworte kurz und präzise auf Deutsch."\n        ).with_model('openai', model)\n        \n        # Send message\n        response_obj = await chat.send_message(UserMessage(text=full_message))\n        response = response_obj.text if hasattr(response_obj, 'text') else str(response_obj)\n        \n        logger.info(f"✅ AI Response: {len(response)} chars")\n        return response\n        \n    except Exception as e:\n        logger.error(f"AI Chat error: {e}")\n        return f"Fehler: {str(e)}"